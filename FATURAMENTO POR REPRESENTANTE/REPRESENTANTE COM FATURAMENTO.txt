

SELECT A.CODVEND, VEN.APELIDO, COUNT(A.NUNOTA)AS PEDIDOS, SUM(A.VLR_FATURAMENTO)AS VL_TOTAL, (SUM(A.VLR_FATURAMENTO) / :V_TOT_FAT *100) AS PERC FROM (

SELECT CAB.CODVEND,X.NUNOTA,
	SUM((CASE WHEN CAB.TIPMOV='D' AND
	:IPI = 1  THEN -1 *(ITE.VLRTOT - ITE.VLRDESC - VLRREPRED) - 
		(CASE WHEN :ST = 2 THEN ITE.VLRSUBST WHEN :ST = 1 THEN 0 END)

	WHEN CAB.TIPMOV='D' AND 
		:IPI = 2 THEN -1 * (ITE.VLRTOT - ITE.VLRDESC - VLRREPRED) - ITE.VLRIPI 
	- (CASE WHEN  :ST = 2 THEN ITE.VLRSUBST 
			WHEN :IPI = 2 THEN 0 END)
		
	WHEN :IPI = 1 THEN (ITE.VLRTOT - ITE.VLRDESC - VLRREPRED) + 
	( CASE WHEN :ST = 1 THEN 0
					WHEN  :ST = 2 THEN ITE.VLRSUBST
					ELSE ITE.VLRSUBST END) 
			
			 ELSE (ITE.VLRTOT - ITE.VLRDESC - VLRREPRED)  + ITE.VLRIPI 
			+
	(CASE WHEN :ST = 1 THEN 0 
					WHEN :ST = 2 THEN  ITE.VLRSUBST
					ELSE ITE.VLRSUBST END)END)) AS VLR_FATURAMENTO
	FROM  (
SELECT 
	CAB.NUNOTA,
	CAB.DTNEG,
	CAB.CODNAT,
	CAB.STATUSNOTA,
	CAB.CODTIPOPER,
	(SELECT TOP 1 NUMNOTA FROM TGFCAB INNER JOIN TGFVAR ON TGFVAR.NUNOTA = TGFCAB.NUNOTA WHERE TGFVAR.NUNOTAORIG = CAB.NUNOTA ) AS NFE,
	(SELECT TOP 1 TGFCAB.NUNOTA FROM TGFCAB INNER JOIN TGFVAR ON TGFVAR.NUNOTA = TGFCAB.NUNOTA WHERE TGFVAR.NUNOTAORIG = CAB.NUNOTA ) AS NUNOTA_NFE
FROM TGFCAB CAB
	INNER JOIN TGFTOP TOPE ON TOPE.CODTIPOPER = CAB.CODTIPOPER
WHERE  CAB.DTNEG <=  :PERIODO.FIN
AND CAB.TIPMOV = 'P'
AND CAB.CODNAT IN :DIVISAO
AND TOPE.ATUALFIN = 1
AND TOPE.TIPATUALFIN ='P'
--AND CAB.CODTIPOPER NOT IN (900,1003,1251,1252,1259,1266,1267,1269,1270,1273,1278,1279,1280,1286,1287,1288,1292,1295,1311,1315,1321,1336,1349)
AND CAB.STATUSNOTA ='L'
AND CAB.CODEMP IN :EMPRESA
GROUP BY CAB.NUNOTA,
	CAB.DTNEG,
	CAB.CODNAT,
	CAB.STATUSNOTA,
	CAB.CODTIPOPER
UNION 
SELECT
	CAB.NUNOTA,
	CAB.DTNEG,
	CAB.CODNAT,
	CAB.STATUSNOTA,
	CAB.CODTIPOPER,
	CAB.NUMNOTA AS NFE,
	CAB.NUNOTA AS NUNOTA_NFE
FROM TGFCAB CAB 
	INNER JOIN TGFTOP TOPE ON TOPE.CODTIPOPER = CAB.CODTIPOPER
WHERE CAB.DTNEG BETWEEN  :PERIODO.INI AND :PERIODO.FIN
AND CAB.TIPMOV = 'D' 
AND CODNAT IN :DIVISAO
AND TOPE.ATUALFIN = -1
AND TOPE.TIPATUALFIN ='I'
--AND  CAB.CODTIPOPER IN(1200,1201,1235,1236,1248,1249,1264,1265,1293,1304,1305,1343,1346)
AND STATUSNOTA='L'
AND CAB.CODEMP IN :EMPRESA
GROUP BY CAB.NUNOTA,
	CAB.DTNEG,
	CAB.CODNAT,
	CAB.STATUSNOTA,
	CAB.CODTIPOPER,
	CAB.NUMNOTA
)X
	INNER JOIN TGFITE ITE ON ITE.NUNOTA = X.NUNOTA_NFE
	INNER JOIN TGFCAB CAB ON CAB.NUNOTA = X.NUNOTA_NFE 
	INNER JOIN TGFPRO PRO ON PRO.CODPROD = ITE.CODPROD

WHERE CAB.DTNEG BETWEEN  :PERIODO.INI AND :PERIODO.FIN
AND (CAB.STATUSNFE = 'A' OR CAB.CODTIPOPER IN (SELECT TGFTOP.CODTIPOPER FROM TGFTOP WHERE ATUALFIN = -1 AND TIPATUALFIN ='I'))
AND (ITE.VLRUNIT > 0.01 OR ITE.VLRTOT = 0.01)

GROUP BY CAB.CODVEND,X.NUNOTA

)A

	INNER JOIN TGFVEN VEN ON VEN.CODVEND = A.CODVEND

GROUP BY A.CODVEND, VEN.APELIDO

