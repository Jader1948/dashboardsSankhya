


SELECT ((Y.VENDA / Y.META)*100)AS PERCENTUAL FROM( 

SELECT
	SUM(CASE WHEN X.SINAL= 'V' THEN X.VL_TOTAL ELSE 0 END) AS VENDA,
	SUM(CASE WHEN X.SINAL= 'M' THEN X.VL_TOTAL ELSE 0 END) AS META

	FROM (

SELECT SUM(A.VL_TOTAL) AS VL_TOTAL, 'V' SINAL
FROM(

SELECT ROUND ( SUM(Z.VLR_FATURAMENTO),2) AS VL_TOTAL  FROM (
SELECT
	X.*,  SUM((CASE WHEN X.CODTIPOPER IN (1200,1201,1235,1236,1248,1249,1264,1265,1293,1304,1305) 
			THEN -1 * (ITE.QTDNEG*ITE.VLRUNIT - ITE.VLRDESC) 
			ELSE (ITE.QTDNEG*ITE.VLRUNIT - ITE.VLRDESC)END)) AS VLR_FATURAMENTO,
	CAB.DTNEG AS DATA_FATURAMENTO
	FROM  (
SELECT 
	CAB.NUNOTA,
	CAB.DTNEG,
	CAB.CODNAT,
	CAB.STATUSNOTA,
	CAB.CODTIPOPER,
	(SELECT TOP 1 NUNOTA FROM TGFVAR WHERE NUNOTAORIG = CAB.NUNOTA) AS NFE
FROM TGFCAB CAB
WHERE  CAB.DTNEG BETWEEN '2023/04/01' and '2023/04/30'
AND CAB.TIPMOV = 'P'
AND CAB.CODNAT = 1010100 
AND CAB.CODTIPOPER NOT IN (900,1259,1200,1269,1266,1270,1293,1294)
AND CAB.STATUSNOTA='L'
GROUP BY CAB.NUNOTA,
	CAB.DTNEG,
	CAB.CODNAT,
	CAB.STATUSNOTA,
	CAB.CODTIPOPER
UNION 
SELECT CAB.NUNOTA,
	CAB.DTNEG,
	CAB.CODNAT,
	CAB.STATUSNOTA,
	CAB.CODTIPOPER,
	CAB.NUNOTA AS NFE
FROM TGFCAB CAB 
WHERE CAB.DTNEG BETWEEN '2023/04/01' and '2023/04/30'
AND TIPMOV = 'D' 
AND CODNAT = 1010100
AND  CAB.CODTIPOPER IN(1200,1201,1235,1236,1248,1249,1264,1265,1293,1304,1305)
AND STATUSNOTA='L'
)X
	INNER JOIN TGFITE ITE ON ITE.NUNOTA = X.NUNOTA
	INNER JOIN TGFCAB CAB ON CAB.NUNOTA = X.NFE

GROUP BY X.NUNOTA,
	X.DTNEG,
	X.CODNAT,
	X.STATUSNOTA,
	X.CODTIPOPER,
	X.NFE,
	CAB.DTNEG

)Z


UNION ALL

SELECT ROUND ( SUM(Y.VLR_FATURAMENTO),2) AS VL_TOTAL  FROM (
SELECT
	X.*,  SUM((CASE WHEN X.CODTIPOPER IN (1200,1201,1235,1236,1248,1249,1264,1265,1293,1304,1305) 
			THEN -1 *(ITE.QTDNEG*ITE.VLRUNIT - ITE.VLRDESC) 
			ELSE (ITE.QTDNEG*ITE.VLRUNIT - ITE.VLRDESC)END)) AS VLR_FATURAMENTO,
	CAB.DTNEG AS DATA_FATURAMENTO
	FROM  (
SELECT 
	CAB.NUNOTA,
	CAB.DTNEG,
	CAB.CODNAT,
	CAB.STATUSNOTA,
	CAB.CODTIPOPER,
	(SELECT TOP 1 NUNOTA FROM TGFVAR WHERE NUNOTAORIG = CAB.NUNOTA) AS NFE
FROM TGFCAB CAB
WHERE  CAB.DTNEG BETWEEN '2023/04/01' and '2023/04/30'
AND CAB.TIPMOV = 'P'
AND CAB.CODNAT = 1010200 
AND CAB.CODTIPOPER NOT IN (900,1259,1200,1269,1266,1270,1293,1294)
AND CAB.STATUSNOTA='L'
GROUP BY CAB.NUNOTA,
	CAB.DTNEG,
	CAB.CODNAT,
	CAB.STATUSNOTA,
	CAB.CODTIPOPER
UNION 
SELECT CAB.NUNOTA,
	CAB.DTNEG,
	CAB.CODNAT,
	CAB.STATUSNOTA,
	CAB.CODTIPOPER,
	CAB.NUNOTA AS NFE
FROM TGFCAB CAB 
WHERE CAB.DTNEG BETWEEN '2023/04/01' and '2023/04/30'
AND TIPMOV = 'D' 
AND CODNAT = 1010200
AND  CAB.CODTIPOPER IN(1200,1201,1235,1236,1248,1249,1264,1265,1293,1304,1305)
AND STATUSNOTA='L'
)X
	INNER JOIN TGFITE ITE ON ITE.NUNOTA = X.NUNOTA
	INNER JOIN TGFCAB CAB ON CAB.NUNOTA = X.NFE

GROUP BY X.NUNOTA,
	X.DTNEG,
	X.CODNAT,
	X.STATUSNOTA,
	X.CODTIPOPER,
	X.NFE,
	CAB.DTNEG

)Y

UNION ALL

SELECT (W.VL_TOTAL) AS VL_TOTAL FROM
(
  SELECT SUM(VALOR)AS VL_TOTAL
FROM AD_VALORECOMMERCE
WHERE DT BETWEEN '2023/04/01' and '2023/04/30'
)W

)A

UNION ALL


SELECT SUM(X.VL_TOTAL)AS VL_TOTAL, 'M' SINAL FROM(

SELECT PREVREC  AS VL_TOTAL
FROM TGMMET 
WHERE CODMETA = 21 AND 
CODNAT = 1010100 AND 
DTREF between '2023/04/01' and '2023/04/30'

UNION ALL

SELECT PREVREC  AS VL_TOTAL
FROM TGMMET 
WHERE CODMETA = 21 AND 
CODNAT = 1010200 AND 
DTREF between '2023/04/01' and '2023/04/30'

UNION ALL

SELECT PREVREC AS VL_TOTAL
FROM TGMMET 
WHERE CODMETA = 21 AND 
CODNAT = 1010300 AND 
DTREF between '2023/04/01' and '2023/04/30'

)X

)X

)Y