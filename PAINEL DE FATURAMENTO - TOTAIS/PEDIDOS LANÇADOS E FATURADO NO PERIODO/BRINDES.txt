
SELECT ISNULL(SUM(W.VLR_FATURAMENTO),0) AS VL_TOTAL FROM (

SELECT
X.*,SUM((CASE WHEN CAB.TIPMOV ='D' AND
	:IPI = 1  THEN -1 *(ITE.VLRTOT - ITE.VLRDESC - VLRREPRED) - 
		(CASE WHEN :ST = 2 THEN ITE.VLRSUBST WHEN :ST = 1 THEN 0 END)

	WHEN CAB.TIPMOV ='D' AND 
		:IPI = 2 THEN -1 * (ITE.VLRTOT - ITE.VLRDESC - VLRREPRED) - ITE.VLRIPI 
	- (CASE WHEN  :ST = 2 THEN ITE.VLRSUBST 
			WHEN :IPI = 2 THEN 0 END)
		
	WHEN :IPI = 1 THEN (ITE.VLRTOT - ITE.VLRDESC - VLRREPRED) + 
	( CASE WHEN :ST = 1 THEN 0
					WHEN  :ST = 2 THEN ITE.VLRSUBST
					ELSE ITE.VLRSUBST END) 
			
			 ELSE (ITE.VLRTOT - ITE.VLRDESC - VLRREPRED)  + ITE.VLRIPI 
			+
	(CASE WHEN :ST = 1 THEN 0 
					WHEN :ST = 2 THEN  ITE.VLRSUBST
					ELSE ITE.VLRSUBST END)END)) AS VLR_FATURAMENTO
	FROM  (
SELECT 
	CAB.NUNOTA,
	CAB.DTNEG,
	CAB.CODNAT,
	CAB.STATUSNOTA,
	CAB.CODTIPOPER,
	(SELECT TOP 1 NUMNOTA FROM TGFCAB INNER JOIN TGFVAR ON TGFVAR.NUNOTA = TGFCAB.NUNOTA WHERE TGFVAR.NUNOTAORIG = CAB.NUNOTA ) AS NFE,
	(SELECT TOP 1 TGFCAB.NUNOTA FROM TGFCAB INNER JOIN TGFVAR ON TGFVAR.NUNOTA = TGFCAB.NUNOTA WHERE TGFVAR.NUNOTAORIG = CAB.NUNOTA ) AS NUNOTA_NFE
FROM TGFCAB CAB
		INNER JOIN TGFTOP TOPE ON TOPE. CODTIPOPER = CAB.CODTIPOPER
WHERE  CAB.DTNEG BETWEEN :PERIODO.INI AND  :PERIODO.FIN
AND CAB.TIPMOV = 'P'
AND CAB.CODNAT = 1010100 
AND CAB.STATUSNOTA ='L'
AND TOPE.ATUALFIN = 1
AND TOPE.TIPATUALFIN ='P'
AND CAB.CODEMP IN :EMPRESA
GROUP BY CAB.NUNOTA,
	CAB.DTNEG,
	CAB.CODNAT,
	CAB.STATUSNOTA,
	CAB.CODTIPOPER
)X
	INNER JOIN TGFITE ITE ON ITE.NUNOTA = X.NUNOTA
	INNER JOIN TGFCAB CAB ON CAB.NUNOTA = X.NUNOTA_NFE 

WHERE CAB.DTNEG BETWEEN :PERIODO.INI AND  :PERIODO.FIN
AND (CAB.STATUSNFE = 'A' )
AND (ITE.VLRUNIT > 0.01 OR ITE.VLRTOT = 0.01)
GROUP BY X.NUNOTA,
	X.DTNEG,
	X.CODNAT,
	X.STATUSNOTA,
	X.CODTIPOPER,
	X.NFE,
	X.NUNOTA_NFE,
	CAB.DTNEG

)W