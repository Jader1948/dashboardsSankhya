SELECT  SUM(Y.VLR_FATURAMENTO) AS VLR_FATURAMENTO  FROM (
SELECT
X.*,SUM((CASE WHEN CAB.TIPMOV='D' AND
	:IPI = 1  THEN -1 *(ITE.VLRTOT - ITE.VLRDESC - VLRREPRED) - 
		(CASE WHEN :ST = 2 THEN ITE.VLRSUBST WHEN :ST = 1 THEN 0 END)

	WHEN CAB.TIPMOV='D' AND 
		:IPI = 2 THEN -1 * (ITE.VLRTOT - ITE.VLRDESC - VLRREPRED) - ITE.VLRIPI 
	- (CASE WHEN  :ST = 2 THEN ITE.VLRSUBST 
			WHEN :IPI = 2 THEN 0 END)
		
	WHEN :IPI = 1 THEN (ITE.VLRTOT - ITE.VLRDESC - VLRREPRED) + 
	( CASE WHEN :ST = 1 THEN 0
					WHEN  :ST = 2 THEN ITE.VLRSUBST
					ELSE ITE.VLRSUBST END) 
			
			 ELSE (ITE.VLRTOT - ITE.VLRDESC - VLRREPRED)  + ITE.VLRIPI 
			+
	(CASE WHEN :ST = 1 THEN 0 
					WHEN :ST = 2 THEN  ITE.VLRSUBST
					ELSE ITE.VLRSUBST END)END)) AS VLR_FATURAMENTO
	FROM  (
SELECT 
	CAB.NUNOTA,
	CAB.DTNEG,
	CAB.CODNAT,
	CAB.STATUSNOTA,
	CAB.CODTIPOPER
FROM TGFCAB CAB
		INNER JOIN TGFTOP TOPE ON TOPE. CODTIPOPER = CAB.CODTIPOPER
WHERE  CAB.DTNEG <= :PERIODO.FIN
AND CAB.TIPMOV = 'P'
AND TOPE.ATUALFIN = 1
AND TOPE.TIPATUALFIN ='P'
AND CAB.CODNAT = 1010100 
AND CAB.NUNOTA NOT IN (SELECT NUNOTAORIG FROM TGFVAR WHERE NUNOTAORIG = CAB.NUNOTA)
AND CAB.DANFE IS NULL AND CAB.NUMNOTA > 0
AND CAB.AD_APROVLAYOUT= 'S'
AND CAB.PENDENTE = 'S'
AND CAB.CODEMP IN :EMPRESA
GROUP BY CAB.NUNOTA,
	CAB.DTNEG,
	CAB.CODNAT,
	CAB.STATUSNOTA,
	CAB.CODTIPOPER
)X
	INNER JOIN TGFITE ITE ON ITE.NUNOTA = X.NUNOTA
	INNER JOIN TGFCAB CAB ON CAB.NUNOTA = X.NUNOTA
GROUP BY X.NUNOTA,
	X.DTNEG,
	X.CODNAT,
	X.STATUSNOTA,
	X.CODTIPOPER
)Y