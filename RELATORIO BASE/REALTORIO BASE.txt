SELECT X.NUMNOTA AS NFE,
	X.SERIENOTA,
	COALESCE(X.PEDIDO,0) AS PEDIDO,
	X.DTNEG AS DATA,
	(CASE WHEN X.MOVIMENTO = 'V' THEN X.VLRNOTA 
		WHEN X.MOVIMENTO = 'D' THEN -1 *(X.VLRNOTA - X.VLRIPI - X.VLRSUBST)END) AS VALOR_COM_IMPOSTO,

	(CASE WHEN X.MOVIMENTO ='V' THEN (X.VLRNOTA - X.VLRIPI - X.VLRSUBST)
		WHEN X.MOVIMENTO = 'D' THEN -1 *(X.VLRNOTA - X.VLRIPI - X.VLRSUBST)END) AS VALOR_SEM_IMPOSTO,

	COALESCE((CASE WHEN (TOP1.ATUALFIN = 1 AND TOP1.TIPATUALFIN='I') AND X.MOVIMENTO ='V' THEN X.VLRNOTA
				WHEN (TOP1.ATUALFIN = -1 AND TOP1.TIPATUALFIN='I') AND X.MOVIMENTO = 'D' THEN  -1* (X.VLRNOTA)END),0) 	FATURAMENTO_COM_IMPOSTO,
	
	COALESCE((CASE WHEN (TOP1.ATUALFIN = 1 AND TOP1.TIPATUALFIN='I') AND X.MOVIMENTO ='V' THEN (X.VLRNOTA - X.VLRIPI - VLRSUBST)
			WHEN (TOP1.ATUALFIN = -1 AND TOP1.TIPATUALFIN='I') AND X.MOVIMENTO = 'D' THEN  -1* (X.VLRNOTA - X.VLRIPI - VLRSUBST )END),0) FATURAMENTO_SEM_IMPOSTO,

	COALESCE((CASE WHEN X.CODNAT = '1010200' THEN (SELECT LOJ.VLRCOMISSAO FROM AD_CALCCOMISSAO LOJ WHERE 	LOJ.NUNOTA = X.PEDIDO)
		WHEN X.CODNAT = '1010100' THEN (SELECT SUM(VLRCOMISSAO) FROM AD_COMISSAOBRINDE WHERE NUNOTA = X.PEDIDO AND DTNEG BETWEEN :PERIODO.INI AND :PERIODO.FIN) END),0) AS VALOR_COMISSAO,
	X.CODNAT,
	X.NATUREZA,
	X.CODTOP,
	X.DESCTOP,
	X.VENDEDOR,
	X.NOME_VEND,
	(CASE WHEN X.STATUS_NOTA = 'L' THEN 'NOTA LIBERADA' 
		WHEN X.STATUS_NOTA = 'A' THEN 'AGUARDANDO ATENDIMENTO'
		WHEN X.STATUS_NOTA = 'D' THEN 'NOTA DENEGADA'
		WHEN X.STATUS_NOTA = 'C' THEN 'NOTA CANCELADA'END) AS STATUS_NOTA,
	(CASE WHEN X.MOVIMENTO = 'V' THEN 'VENDA' 
		ELSE 'DEVOLUÇÃO'END) AS TIPO_MOVIMENTO
FROM (

SELECT  CAB.NUMNOTA,
	CAB.SERIENOTA,
	(SELECT TOP 1 NUNOTAORIG FROM TGFVAR WHERE NUNOTA = CAB.NUNOTA) AS PEDIDO,
	CAB.DTNEG,
	CAB.VLRNOTA,
	CAB.VLRIPI,
	CAB.VLRSUBST,
	CAB.CODNAT AS CODNAT,
	NAT.DESCRNAT AS NATUREZA,
	CAB.CODTIPOPER AS CODTOP,
	TOP1.DESCROPER AS DESCTOP,
	CAB.STATUSNOTA AS STATUS_NOTA,
	CAB.CODVEND AS VENDEDOR,
	VEN.APELIDO AS NOME_VEND,
	CAB.TIPMOV AS MOVIMENTO

FROM TGFCAB CAB
	INNER JOIN TGFNAT NAT ON NAT.CODNAT = CAB.CODNAT
	INNER JOIN TGFTOP TOP1 ON TOP1.CODTIPOPER = CAB.CODTIPOPER
	INNER JOIN TGFVEN VEN ON VEN.CODVEND = CAB.CODVEND


WHERE  CAB.DTNEG BETWEEN :PERIODO.INI AND :PERIODO.FIN
AND CAB.TIPMOV IN ('V','D')
AND ((CAB.CODNAT IN :DIVISAO) OR CAB.CODNAT IN(9040000,3022500,2010000))
AND CAB.CODTIPOPER NOT IN (1333)

GROUP BY CAB.NUMNOTA,
	CAB.NUNOTA,
	CAB.DTNEG,
	CAB.VLRNOTA,
	NAT.DESCRNAT,
	CAB.CODTIPOPER,
	TOP1.DESCROPER,
	CAB.STATUSNOTA,
	CAB.CODVEND,
	CAB.CODNAT,
	CAB.TIPMOV,
	CAB.VLRIPI,
	CAB.VLRSUBST,
	CAB.SERIENOTA,
	VEN.APELIDO

)X 
	INNER JOIN TGFTOP TOP1 ON TOP1.CODTIPOPER = X.CODTOP

WHERE X.NUMNOTA > 0 AND X.SERIENOTA IN(1,2,3,4,5,6,7,8,9,10) 
		
GROUP BY X.NUMNOTA,
	X.PEDIDO,
	X.DTNEG,
	X.VLRNOTA,
	X.NATUREZA,
	X.CODTOP,
	X.STATUS_NOTA,
	X.CODNAT,
	X.MOVIMENTO,
	X.VENDEDOR,
	X.VLRIPI,
	X.VLRSUBST,
	X.SERIENOTA,
	X.DESCTOP,
	X.NOME_VEND, 
	TOP1.ATUALFIN,
	TOP1.TIPATUALFIN

UNION ALL
SELECT DISTINCT 
W.NFE, W.SERIENOTA, W.PEDIDO, MAX(W.DHPROTOC) AS DATA1, W.VALOR_COM_IMPOSTO, W.VALOR_SEM_IMPOSTO, 
W.FATURAMENTO_COM_IMPOSTO, W.FATURAMENTO_SEM_IMPOSTO, W.VALOR_COMISSAO, W.CODNAT, W.NATUREZA, 
W.CODTOP, W.DESCTOP, W.VENDEDOR, W.NOME_VEND, W.STATUS_NOTA, 
W.TIPO_MOVIMENTO
FROM (
SELECT NUMNOTA AS NFE, SERIENOTA, 0 AS PEDIDO, TGFINU.DHPROTOC, 0 AS VALOR_COM_IMPOSTO, 0 AS VALOR_SEM_IMPOSTO, 
0 AS FATURAMENTO_COM_IMPOSTO, 0 AS FATURAMENTO_SEM_IMPOSTO, 0 AS VALOR_COMISSAO, 0 AS CODNAT, SPACE(1) AS NATUREZA, 
0 AS CODTOP, SPACE(1) AS DESCTOP, 0 AS VENDEDOR, SPACE(1) AS NOME_VEND, 'INUTILIZADA/CANCELADA' AS STATUS_NOTA, 
'INUTILIZADA/CANCELADA' AS TIPO_MOVIMENTO FROM TGFINU WHERE DHPROTOC BETWEEN :PERIODO.INI AND :PERIODO.FIN 
UNION ALL 
SELECT NUMNOTA AS NFE, SERIENOTA, 0 AS PEDIDO, DTNEG,0 AS VALOR_COM_IMPOSTO, 0 AS VALOR_SEM_IMPOSTO, 
0 AS FATURAMENTO_COM_IMPOSTO, 0 AS FATURAMENTO_SEM_IMPOSTO, 0 AS VALOR_COMISSAO, 0 AS CODNAT, SPACE(1) AS NATUREZA, 
0 AS CODTOP, SPACE(1) AS DESCTOP, 0 AS VENDEDOR, SPACE(1) AS NOME_VEND, 'INUTILIZADA/CANCELADA' AS STATUS_NOTA, 
'INUTILIZADA/CANCELADA' AS TIPO_MOVIMENTO FROM TGFCAB_EXC WHERE TIPMOV IN('V') AND DTNEG BETWEEN :PERIODO.INI AND :PERIODO.FIN
AND NUMNOTA > 0 AND SERIENOTA IS NOT NULL AND SERIENOTA IN(8,9) 
) W 
GROUP BY W.NFE, W.SERIENOTA, W.PEDIDO, W.VALOR_COM_IMPOSTO, W.VALOR_SEM_IMPOSTO, 
W.FATURAMENTO_COM_IMPOSTO, W.FATURAMENTO_SEM_IMPOSTO, W.VALOR_COMISSAO, W.CODNAT, W.NATUREZA, 
W.CODTOP, W.DESCTOP, W.VENDEDOR, W.NOME_VEND, W.STATUS_NOTA, 
W.TIPO_MOVIMENTO 
UNION ALL 
SELECT NUMNOTA AS NFE, SERIENOTA, 0 AS PEDIDO, DTNEG, 0 AS VALOR_COM_IMPOSTO, 0 AS VALOR_SEM_IMPOSTO, 
0 AS FATURAMENTO_COM_IMPOSTO, 0 AS FATURAMENTO_SEM_IMPOSTO, 0 AS VALOR_COMISSAO, 0 AS CODNAT, SPACE(1) AS NATUREZA, 
0 AS CODTOP, SPACE(1) AS DESCTOP, 0 AS VENDEDOR, SPACE(1) AS NOME_VEND, 'APROVADA' AS STATUS_NOTA, 
(CASE WHEN CODTIPOPER = 212 THEN'AJUSTE DE ESTOQUE - ENTRADA' WHEN CODTIPOPER = 203 THEN 'COMPRA NACIONALIZAÇÃO - ENTRADA'END)AS TIPO_MOVIMENTO FROM TGFCAB WHERE TIPMOV = 'C' AND CODTIPOPER IN(203,212) AND STATUSNFE = 'A'
AND DTNEG BETWEEN :PERIODO.INI AND :PERIODO.FIN
 ORDER BY SERIENOTA,	NUMNOTA